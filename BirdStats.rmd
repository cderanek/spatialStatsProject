---
title: "Bird_Project"
author: "Alicia Pentico"
date: "April 21, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Remember that diet is small proxy. Some birds could eat more than others
Moran's I to tell if birds are clustered. 
Diversity analysis?
Add jackknife Analysis
Spatial regression model could have seasonality as factors.

```{r}
library(rgdal) # Provides links to the 'Geospatial' Data Abstraction Library ('GDAL') and access to projection/transformation operations from the 'PROJ.4' library.
library(sp) # Classes and methods for spatial data
library(spdep) # for modeling of spatial dependencies
library(maptools) # provides various mapping functions
library(RANN) # for nearest neighbor calculations
library(gstat)
library(base)

```

### READING IN DATA
```{r}
captureBirds<-read.csv("balbina_understory_birds_captures.csv", header = TRUE)
birdInfo<-read.csv("balbina_understory_birds_taxonomy_traits.csv", header = TRUE)
environment<-read.csv("balbina_environmental_variables.csv", header = TRUE)
```

###DATA FORMATTING
```{r}
noRecaptures <- subset(captureBirds, captureBirds$new.individual == "yes")

perLocation<- as.data.frame(table(noRecaptures$site))
perLocation$longitude<- environment$longitude.WGS84
perLocation$latitude<- environment$latitude.WGS84
perLocation$coverage<- environment$forest.cover.200

names(perLocation)<- c("site", "abundance", "longitude", "latitude","coverage")
str(perLocation)

# create vectors to hold species richness and names to later add as cols to perLocation
speciesRichnessBySite=vector('integer',length=length(perLocation$site))
speciesNamesBySite=vector('list',length=length(perLocation$site))

# get number of species at each site, list of species at each site
# TODO FORMAT SUCH THAT WE MAKE READY FOR SPEC ACCUM - CARISSA TASK
for (i in 1:length(perLocation$site)){
  siteName = perLocation$site[i]
  
  # operations to get T/F list of species at site
  set<-subset(noRecaptures, site == siteName)
  byLocation <- as.data.frame(table(set$species))
  speciesFoundatSite = (byLocation$Freq != 0)
  
  # add speciesRichness to vector
  speciesRichnessBySite[i] = sum(speciesFoundatSite)
  
  speciesFreqs <- list()
  for (j in 1:length(byLocation$Var1)){
    if(byLocation$Freq[j] != 0){
      speciesFreqs[[as.character(byLocation$Var1[j])]] = byLocation$Freq[j]
    }
  }
  speciesNamesBySite[[i]] = speciesFreqs
  
}

# add species richness and names to perLocation
perLocation$speciesRichness<- speciesRichnessBySite
perLocation$speciesNamesL<- speciesNamesBySite
```



###IDW ABUNDANCE, SPECIES RICHNESS - TODO ALICIA

Creating a spatial points data frame
```{r}
### Converting data into a spatial points data frame
perLocation.spdf <- perLocation
coordinates(perLocation.spdf) <- ~ longitude + latitude ##(remember that in R longitude is assigned to x-axis and latitude to y-axis)
class(perLocation.spdf)
bbox(perLocation.spdf)
```

#Abundance 
Data Transformations
```{r}
### Examining normality of the abundance and selected Sqrt transformation
hist(perLocation.spdf@data$abundance) ## Note abundance is not normally distributed. Should transform dataset
qqnorm(perLocation.spdf@data$abundance)
qqline(perLocation.spdf@data$abundance)

hist(log(perLocation.spdf@data$abundance)) ## Log Transformation --> still not great
qqnorm(log(perLocation.spdf@data$abundance))
qqline(log(perLocation.spdf@data$abundance))

hist((sqrt(perLocation.spdf@data$abundance))) ## Sqrt Transformation ---> Transformation I am using
qqnorm((sqrt(perLocation.spdf@data$abundance)))
qqline((sqrt(perLocation.spdf@data$abundance)))

hist(1/(perLocation.spdf@data$abundance)) ## 1/y Transformation --> real bad
qqnorm(1/(perLocation.spdf@data$abundance)) 
qqline(1/(perLocation.spdf@data$abundance))

perLocation.spdf@data$transformedAbundance <- sqrt(perLocation.spdf@data$abundance)
```
Inverse Distance Weighted

```{r}
x.range <- as.numeric(c(-60, -59.15671))  # min/max longitude of the interpolation area
y.range <- as.numeric(c(-1.97378, -1.32884))  # min/max latitude of the interpolation area


grd <- expand.grid(x = seq(from = x.range[1], to = x.range[2], by = 0.001), y = seq(from = y.range[1], 
    to = y.range[2], by = 0.001))  # expand points to grid
coordinates(grd) <- ~x + y
gridded(grd) <- TRUE
plot(grd, cex = 1.5, col = "grey") 
plot(perLocation.spdf, add=TRUE, pch = 1, col = "red", cex = 1)


idw <- gstat::idw(formula = perLocation.spdf@data$transformedAbundance ~ 1, locations = perLocation.spdf, newdata = grd, idp=2.0) 
plot(idw)

```


#Species Richness 
Transformation
```{r}
### Examining normality of the species richness and selected Sqrt transformation
hist(perLocation.spdf@data$speciesRichness)
qqnorm(perLocation.spdf$speciesRichness)
qqline(perLocation.spdf$speciesRichness)

hist(log(perLocation.spdf$speciesRichness)) 
qqnorm(log(perLocation.spdf$speciesRichness)) 
qqline(log(perLocation.spdf$speciesRichness))

hist(sqrt(perLocation.spdf$speciesRichness)) 
qqnorm(sqrt(perLocation.spdf$speciesRichness)) 
qqline(sqrt(perLocation.spdf$speciesRichness))

hist(1/(perLocation.spdf$speciesRichness)) 
qqnorm(1/(perLocation.spdf$speciesRichness)) 
qqline(1/(perLocation.spdf$speciesRichness))

perLocation.spdf@data$transformedRichness <- sqrt(perLocation.spdf@data$speciesRichness)
```


IDW
```{r}
idw <- gstat::idw(formula = perLocation.spdf@data$transformedRichness ~ 1, locations = perLocation.spdf, newdata = grd, idp=2.0) 
plot(idw)

```


###DIET ANALYSES

Data Wrangling
```{r}
dietL <- c("diet.inv", "diet.vend", "diet.vect", "diet.vfish","diet.vunk","diet.fruit","diet.nect","diet.seed","diet.planto")
dietByRegion <- matrix(1:342, nrow = 38, ncol = 9)
colnames(dietByRegion) <- dietL

for (i in 1:38){ #num rows is each location
  for (j in 1:9){ #num cols is each diet type
    
    food = birdInfo[,dietL[j]] #Vector of particular Diet
    
    sumDiet <- 0
    individualCount <- 0
    
    birdsAtSite <- perLocation$speciesNamesL[[i]]
    birdNames = names(birdsAtSite)
    
    for (k in 1:length(birdNames)){
      bird = birdNames[k]
      numBirds = birdsAtSite[[bird]]
      
      individualCount <- individualCount+numBirds
      
      birdLocation = match(bird, birdInfo$birdlife.2016)
      if (is.na(birdLocation)){
        birdLocation = match(bird, birdInfo$cbro.2015)
      }
      else if (is.na(birdLocation)){
        birdLocation = match(bird, birdInfo$wilman.2014)
      }
      foodEaten = food[birdLocation] #Perent of Diet for that particular bird

      sumDiet <- sumDiet + (numBirds * foodEaten)
      
    }
    
    dietByRegion[i,j] = sumDiet/ (100*individualCount)
  }
}

```
Separating by Diet Type
```{r}
diet.inv <- dietByRegion[,1]
diet.vend <- dietByRegion[,2]
diet.vect <- dietByRegion[,3]
diet.vfishd <- dietByRegion[,4]
diet.vunk <- dietByRegion[,5]
diet.fruit <- dietByRegion[,6]
diet.nect <- dietByRegion[,7]
diet.seed <- dietByRegion[,8]
diet.planto <- dietByRegion[,9]
```

#DIET.INV
TRANSFORMATIONS
```{r}

hist(diet.inv) 
qqnorm(diet.inv)
qqline(diet.inv)

hist(log(diet.inv))
qqnorm(log(diet.inv)) 
qqline(log(diet.inv))

hist(sqrt(diet.inv))
qqnorm(sqrt(diet.inv)) 
qqline(sqrt(diet.inv))

hist(1/(diet.inv)) 
qqnorm(1/(diet.inv)) 
qqline(1/(diet.inv))


### UNTRANSFORMED DIET IS BEST FOR DIET.INV
perLocation.spdf@data$diet.inv <- diet.inv
```
IDW
```{r}
idw <- gstat::idw(formula = perLocation.spdf@data$diet.inv ~ 1, locations = perLocation.spdf, newdata = grd, idp=2.0) 
plot(idw)

```


#DIET.VEND 
TRANSFORMATIONS
```{r}
hist(diet.vend) 
qqnorm(diet.vend)
qqline(diet.vend)

#hist(log(diet.vend)) 
#qqnorm(log(diet.vend)) 
#qqline(log(diet.vend))

hist(sqrt(diet.vend))
qqnorm(sqrt(diet.vend)) 
qqline(sqrt(diet.vend))

hist(asin(sqrt(diet.vend)))
qqnorm(asin(sqrt(diet.vend)))
qqline(asin(sqrt(diet.vend)))

#hist(1/(diet.vend)) 
#qqnorm(1/(diet.vend)) 
#qqline(1/(diet.vend))


### UNTRANSFORMED DIET IS BEST FOR diet.vend <---- STILL NOT GREAT THOUGH
perLocation.spdf@data$diet.vend <- diet.vend
```
IDW
```{r}
idw <- gstat::idw(formula = perLocation.spdf@data$diet.vend ~ 1, locations = perLocation.spdf, newdata = grd, idp=2.0) 
plot(idw)

```


#DIET.VECT 
TRANSFORMATIONS
```{r}
hist(diet.vect) 
qqnorm(diet.vect)
qqline(diet.vect)

#hist(log(diet.vect)) 
#qqnorm(log(diet.vect)) 
#qqline(log(diet.vect))

hist(sqrt(diet.vect))
qqnorm(sqrt(diet.vect)) 
qqline(sqrt(diet.vect))

hist(asin(sqrt(diet.vect)))
qqnorm(asin(sqrt(diet.vect)))
qqline(asin(sqrt(diet.vect)))

#hist(1/(diet.vect)) 
#qqnorm(1/(diet.vect)) 
#qqline(1/(diet.vect))


### UNTRANSFORMED DIET IS BEST FOR diet.vect <---- STILL NOT GREAT THOUGH
perLocation.spdf@data$diet.vect <- diet.vect
```
IDW
```{r}
idw <- gstat::idw(formula = perLocation.spdf@data$diet.vect ~ 1, locations = perLocation.spdf, newdata = grd, idp=2.0) 
plot(idw)

```


#DET.VFISHD 
TRANSORMATIONS
```{r}
### Examining normality of the abundance and selected Sqrt transformation
hist(diet.vfishd) 
qqnorm(diet.vfishd)
qqline(diet.vfishd)

#hist(log(diet.vfishd)) 
#qqnorm(log(diet.vfishd)) 
#qqline(log(diet.vfishd))

hist(sqrt(diet.vfishd))
qqnorm(sqrt(diet.vfishd)) 
qqline(sqrt(diet.vfishd))

hist(asin(sqrt(diet.vfishd)))
qqnorm(asin(sqrt(diet.vfishd)))
qqline(asin(sqrt(diet.vfishd)))

#hist(1/(diet.vfishd)) 
#qqnorm(1/(diet.vfishd)) 
#qqline(1/(diet.vfishd))


### UNTRANSFORMED DIET IS BEST FOR diet.vfishd <---- STILL NOT GREAT THOUGH
perLocation.spdf@data$diet.vfishd <- diet.vfishd
```
IDW
```{r}
idw <- gstat::idw(formula = perLocation.spdf@data$diet.vfishd ~ 1, locations = perLocation.spdf, newdata = grd, idp=2.0) 
plot(idw)

```


#DIET.VUNK 
TRANSFORMATIONS
```{r}
### Examining normality of the abundance and selected Sqrt transformation
hist(diet.vunk) 
qqnorm(diet.vunk)
qqline(diet.vunk)

#hist(log(diet.vunk)) 
#qqnorm(log(diet.vunk)) 
#qqline(log(diet.vunk))

hist(sqrt(diet.vunk))
qqnorm(sqrt(diet.vunk)) 
qqline(sqrt(diet.vunk))

hist(asin(sqrt(diet.vunk)))
qqnorm(asin(sqrt(diet.vunk)))
qqline(asin(sqrt(diet.vunk)))

#hist(1/(diet.vunk)) 
#qqnorm(1/(diet.vunk)) 
#qqline(1/(diet.vunk))


### UNTRANSFORMED DIET IS BEST FOR diet.vunk <---- STILL NOT GREAT THOUGH
perLocation.spdf@data$diet.vunk <- diet.vunk
```
IDW
```{r}
idw <- gstat::idw(formula = perLocation.spdf@data$diet.vunk ~ 1, locations = perLocation.spdf, newdata = grd, idp=2.0) 
plot(idw)

```


#DIET.FRUIT 
TRANSFORMATIONS
```{r}
### Examining normality of the abundance and selected Sqrt transformation
hist(diet.fruit) 
qqnorm(diet.fruit)
qqline(diet.fruit)

#hist(log(diet.fruit)) 
#qqnorm(log(diet.fruit)) 
#qqline(log(diet.fruit))

hist(sqrt(diet.fruit))
qqnorm(sqrt(diet.fruit)) 
qqline(sqrt(diet.fruit))

hist(asin(sqrt(diet.fruit)))
qqnorm(asin(sqrt(diet.fruit)))
qqline(asin(sqrt(diet.fruit)))

#hist(1/(diet.fruit)) 
#qqnorm(1/(diet.fruit)) 
#qqline(1/(diet.fruit))


### UNTRANSFORMED DIET IS BEST FOR diet.fruit <---- STILL NOT GREAT THOUGH
perLocation.spdf@data$diet.fruit <- diet.fruit
```
IDW
```{r}
idw <- gstat::idw(formula = perLocation.spdf@data$diet.fruit ~ 1, locations = perLocation.spdf, newdata = grd, idp=2.0) 
plot(idw)

```


#DIET.NECT 
TRANSFORMATIONS
```{r}
### Examining normality of the abundance and selected Sqrt transformation
hist(diet.nect) 
qqnorm(diet.nect)
qqline(diet.nect)

#hist(log(diet.nect)) 
#qqnorm(log(diet.nect)) 
#qqline(log(diet.nect))

hist(sqrt(diet.nect))
qqnorm(sqrt(diet.nect)) 
qqline(sqrt(diet.nect))

hist(asin(sqrt(diet.nect)))
qqnorm(asin(sqrt(diet.nect)))
qqline(asin(sqrt(diet.nect)))

#hist(1/(diet.nect)) 
#qqnorm(1/(diet.nect)) 
#qqline(1/(diet.nect))


### UNTRANSFORMED DIET IS BEST FOR diet.nect <---- STILL NOT GREAT THOUGH
perLocation.spdf@data$diet.nect <- diet.nect
```
IDW
```{r}
idw <- gstat::idw(formula = perLocation.spdf@data$diet.nect ~ 1, locations = perLocation.spdf, newdata = grd, idp=2.0) 
plot(idw)

```


#DIET.SEED 
TRANSFORMATIONS
```{r}
### Examining normality of the abundance and selected Sqrt transformation
hist(diet.seed) 
qqnorm(diet.seed)
qqline(diet.seed)

#hist(log(diet.seed)) 
#qqnorm(log(diet.seed)) 
#qqline(log(diet.seed))

hist(sqrt(diet.seed))
qqnorm(sqrt(diet.seed)) 
qqline(sqrt(diet.seed))

hist(asin(sqrt(diet.seed)))
qqnorm(asin(sqrt(diet.seed)))
qqline(asin(sqrt(diet.seed)))

#hist(1/(diet.seed)) 
#qqnorm(1/(diet.seed)) 
#qqline(1/(diet.seed))


### SQRT DIET IS BEST FOR diet.seed <---- STILL NOT GREAT THOUGH
perLocation.spdf@data$diet.seed <- sqrt(diet.seed)
```
IDW
```{r}
idw <- gstat::idw(formula = perLocation.spdf@data$diet.seed ~ 1, locations = perLocation.spdf, newdata = grd, idp=2.0) 
plot(idw)

```


#DIET.PLANTO TRANSFORMATIONS
```{r}
### Examining normality of the abundance and selected Sqrt transformation
hist(diet.planto) 
qqnorm(diet.planto)
qqline(diet.planto)

#hist(log(diet.planto)) 
#qqnorm(log(diet.planto)) 
#qqline(log(diet.planto))

hist(sqrt(diet.planto))
qqnorm(sqrt(diet.planto)) 
qqline(sqrt(diet.planto))

hist(asin(sqrt(diet.planto)))
qqnorm(asin(sqrt(diet.planto)))
qqline(asin(sqrt(diet.planto)))

#hist(1/(diet.planto)) 
#qqnorm(1/(diet.planto)) 
#qqline(1/(diet.planto))


### SQRT DIET IS BEST FOR diet.planto <---- STILL NOT GREAT THOUGH
perLocation.spdf@data$diet.planto <- sqrt(diet.planto)
```
IDW
```{r}
idw <- gstat::idw(formula = perLocation.spdf@data$diet.planto ~ 1, locations = perLocation.spdf, newdata = grd, idp=2.0) 
plot(idw)
```

###Species Accumulation
```{r}
#str(captureBirds)
noRecaptures <- subset(captureBirds, captureBirds$new.individual == "yes")

perLocation<- as.data.frame(table(noRecaptures$site))
perLocation$longitude<- environment$longitude.WGS84
perLocation$latitude<- environment$latitude.WGS84
perLocation$coverage<- environment$forest.cover.200

names(perLocation)<- c("site", "abundance", "longitude", "latitude","coverage")
str(perLocation)

# create vectors to hold species richness and names to later add as cols to perLocation
speciesRichnessBySite=vector('integer',length=length(perLocation$site))
speciesNamesBySite=vector('list',length=length(perLocation$site))

# create matrix to pass into species accumulation curve formula
allSpeciesNames = sort(unique(noRecaptures$species),return=TRUE)
specAccumDF <- data.frame(matrix(ncol = length(allSpeciesNames), nrow = length(perLocation$site)))
colnames(specAccumDF) <- allSpeciesNames
row.names(specAccumDF) <- perLocation$site

# get number of species at each site, list of species at each site
for (i in 1:length(perLocation$site)){
  siteName = perLocation$site[i]
  
  # operations to get T/F list of species at site
  set<-subset(noRecaptures, site == siteName)
  byLocation <- as.data.frame(table(set$species))
  speciesFoundatSite = (byLocation$Freq != 0)
  
  # add speciesRichness to vector
  speciesRichnessBySite[i] = sum(speciesFoundatSite)
  speciesNamesBySite[i] = list(as.character(byLocation$Var1[speciesFoundatSite]))
  
  # update specAccumDF
  byLocation[order(byLocation$Var1),] #makes sure things get inputted in correct order
  specAccumDF[i,] = byLocation$Freq
  
}

# add species richness and names to perLocation
perLocation$speciesRichness<- speciesRichnessBySite
perLocation$speciesNamesL<- speciesNamesBySite
```

###BASEMAPS
```{r}
library(leaflet)
medLong = median(perLocation.spdf@coords[,1])
medLat = median(perLocation.spdf@coords[,2])

abundanceVals=sort(perLocation.spdf@data$abundance)
lowerQuarterAbundance = abundanceVals[floor(length(abundanceVals)/4)]
upperQuarterAbundance = abundanceVals[length(abundanceVals)-floor(length(abundanceVals)/4)]

getColor <- function(df) {
  sapply(df$abundance, function(abundance) {
  if(abundance <= lowerQuarterAbundance) {
    "red"
  } else if(abundance <= upperQuarterAbundance) {
    "orange"
  } else {
    "green"
  } })
}

icons <- awesomeIcons(
  icon = 'ios-close',
  iconColor = 'black',
  library = 'ion',
  markerColor = getColor(perLocation.spdf@data)
)


# draw map
m = leaflet(perLocation.spdf) %>% setView(lng = medLong, lat = medLat, zoom = 10)
m %>% addTiles() %>% addAwesomeMarkers(icon=icons, label = ~as.character(abundance), popup=~as.character(site))

```
